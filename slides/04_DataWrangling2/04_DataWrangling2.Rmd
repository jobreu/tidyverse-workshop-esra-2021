---
title: "Introduction to Survey Data Cleaning Using Tidyverse in R"
subtitle: "Data Wrangling - Part 2"
author: "Johannes Breuer<br />Stefan JÃ¼nger"
date: "2021-07-22"
location: "ESRA 2021"
output:
  xaringan::moon_reader:
    self_contained: true
    lib_dir: libs
    css: ["default", "default-fonts", "workshop.css"]
    nature:
      highlightStyle: "github"
      highlightLines: true
      countIncrementalSlides: false
---
layout: true

```{r setup, include = F}
if (!require(easypackages)) install.packages("easypackages")
library(easypackages)

packages("knitr",
         "rmarkdown",
         "tidyverse",
         "gadenbuie/xaringanExtra",
         "gadenbuie/tweetrmd",
         "hadley/emo",
         "sctyner/memer",
         prompt = F)

options(htmltools.dir.version = FALSE,
        htmltools.preserve.raw = FALSE)

opts_chunk$set(echo = TRUE,
               fig.align = "center")

xaringanExtra::use_xaringan_extra(c("tile_view", "clipboard"))
xaringanExtra::use_extra_styles(hover_code_line = TRUE,
                                mute_unhighlighted_code = FALSE)
```

<div class="my-footer">
  <div style="float: left;"><span>`r gsub("<br />", ", ", gsub("<br /><br />|<a.+$", "", metadata$author))`</span></div>
  <div style="float: right;"><span>`r metadata$location`, `r metadata$date`</span></div>
  <div style="text-align: center;"><span>`r gsub(".+<br />", " ", metadata$subtitle)`</span></div>
</div>

---

## Data wrangling continued `r ji("cowboy_hat_face")`

While in the last session we focused on changing the structure of our data by **selecting**, **renaming**, and **relocating** columns and **filtering** and **arranging** rows, in this part we will focus on altering the content of data sets by *adding* and *changing* variables and variable values. More specifically, we will deal with...

- creating and computing new variables (in various ways)

- recoding the values of a variable

- dealing with missing values

```{r load data, echo = F, message = F}
gpc <- read_csv("../../data/ZA5667_v1-0-0_Stata14_synthetic-data.csv")
```

---

## `dplyr::mutate()`

```{r, mutate-cartoon, out.width = "60%", echo = F}
include_graphics("./pics/dplyr_mutate.png")
```
<small><small>Artwork by [Allison Horst](https://github.com/allisonhorst/stats-illustrations)</small></small>

---

## Creating a new variable

A simple example for creating a new variable is adding a numeric ID variable based on the row number in the data set.

.small[
```{r id}
gpc <- gpc %>% 
  mutate(id = row_number()) %>% #<<
  relocate(id, .before = everything()) # move the id column before all other columns

gpc %>% 
  select(1:5) %>% 
  glimpse
```
]

*Note*: The function `rowid_to_column()` from the `tibble` package is an alternative for this which also automatically includes the id variable as the first column.

---

## Recoding values

Very often we want to recode values in a variable (e.g., if we have reverse-scored items as part of a scale). Say, for example, you want to recode the item from the *GESIS Panel Special Survey on the Coronavirus SARS-CoV-2 Outbreak in Germany* that measures trust in scientists with regard to dealing with the Coronavirus to represent distrust.

.small[
```{r recode}
gpc <- gpc %>% 
  mutate(hzcy052aR = recode(hzcy052a,
                           `5` = 1, # `old value` = new value
                           `4` = 2,
                           `2` = 4,
                           `1` = 5))

gpc %>% 
  select(hzcy052a, hzcy052aR) %>% 
  head()
```
]

---

## Missing values

Most of the real datasets we work with have missing data. As the data can be missing for various reasons, we often use codes (and labels) to distinguish between different types of missing data.

If you look at the the [codebook](https://dbk.gesis.org/dbksearch/download.asp?id=67378) of the *GESIS Panel Special Survey on the Coronavirus SARS-CoV-2 Outbreak in Germany* or the [*GESIS Panel* Cheatsheet](https://www.gesis.org/fileadmin/upload/GESIS_Panel/Cheatsheet/gesis_panel_cheatsheet.pdf), you will see that there are quite a few types of and codes for missing data. Some types of missing values are the same across variables, while some variables also have additional types of missing data (and, hence, additional codes for missings).

Notably, however, in the process of creating the synthetic data we use in this course, all values < 0 have been changed to `NA`.<sup>1</sup>

.footnote[
[1] `NA` is a reserved term in `R`, meaning that you cannot use it as a name for anything else (this is also the case for `TRUE` and `FALSE`)
]

---

## Wrangling missing values

When we prepare our data for analysis there are generally two things we might want/have to do with regard to missing values:

- define specific values as missings (i.e., set them to `NA`)

- recode `NA` values into something else (typically to distinguish between different types of missing values)

---

## Recode values as `NA`

If you want to recode specific values as `NA`, you can use the is the `dplyr` function `na_if()`. You can do this for an entire dataframe...<sup>1</sup>

```{r na-if-all, eval=FALSE}
gpc <- gpc %>% 
  na_if(98) # here we just provide the value to be recoded as NA for all vars
```

.footnote[
[1] Remember that all values < 0 have been set as `NA` in this synthetic dataset (unlike in the original data), but there are some values that contain the value 98 representing the response option *I don't know*.
]

---

## Recode values as `NA`

... for individual variables, in which case you need to combine `na_if()` with `mutate()`,...

```{r na-if-one, eval=FALSE}
gpc <- gpc %>% 
  mutate(hzcy044a = na_if(hzcy044a, 98))
```

---

## Recode values as `NA`

... or for a range of variables. In this case you need to also add the helper function `across()` to the mix, which allows you to apply the same transformation to multiple columns.

```{r na-if-across}
gpc <- gpc %>% 
  mutate(across(hzcy044a:hzcy052a, ~na_if(.x, 98)))
```

---

class: center, middle

# [Exercise](https://jobreu.github.io/tidyverse-workshop-esra-2021/exercises/DataWrangling2_question.html) time `r ji("weight_lifting_woman")``r ji("muscle")``r ji("running_man")``r ji("biking_man")`

## [Solutions](https://jobreu.github.io/tidyverse-workshop-esra-2021/solutions/DataWrangling2_solution.html)